<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ plan.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body class="bg-light">

    <nav class="navbar navbar-dark bg-dark mb-4">
        <div class="container">
            <span class="navbar-brand fw-bold text-truncate" style="max-width: 200px;">{{ plan.name }}</span>
            <div>
                <a href="/court_mode/{{ plan.id }}" class="btn btn-outline-warning btn-sm me-1" target="_blank"><i class="bi bi-phone-landscape"></i> Modo Pista (Solo ver)</a>
                <a href="/my_plans" class="btn btn-outline-light btn-sm">Volver</a>
            </div>
        </div>
    </nav>

    <div class="container pb-5">
        
        <div class="card shadow-sm border-primary mb-4">
            <div class="card-body bg-white">
                <div class="row align-items-center">
                    <div class="col-md-7">
                        <h4 class="fw-bold text-primary mb-1">üöÄ Ejecutar este Plan</h4>
                        <p class="text-muted small mb-0">Convierte este dise√±o en una sesi√≥n real, controla asistencia y gamifica.</p>
                    </div>
                    <div class="col-md-5 mt-3 mt-md-0">
                        <form action="/start_session" method="POST" class="d-flex gap-2">
                            <input type="hidden" name="plan_id" value="{{ plan.id }}">
                            <select name="team_id" class="form-select fw-bold" required>
                                <option value="" disabled selected>Elige Equipo...</option>
                                {% for t in teams %}
                                <option value="{{ t.id }}">{{ t.name }}</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-primary fw-bold text-nowrap">Empezar</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted fw-bold small">DATOS GENERALES</h6>
                        <hr class="my-2">
                        <p class="mb-1"><strong>Equipo:</strong> {{ plan.team_name or 'Sin asignar' }}</p>
                        <p class="mb-1"><strong>Duraci√≥n:</strong> {{ total_minutes }} min</p>
                        <p class="mb-0"><strong>Ejercicios:</strong> {{ plan.items|length }}</p>
                    </div>
                </div>
                
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="text-muted fw-bold small">NOTAS</h6>
                        <hr class="my-2">
                        <p class="small text-muted">{{ plan.notes or 'Sin notas' }}</p>
                    </div>
                </div>

                <div class="d-grid gap-2">
                    {% if plan.user_id == current_user.id %}
                    <a href="/edit_plan/{{ plan.id }}" class="btn btn-outline-secondary">‚úèÔ∏è Editar Plan</a>
                    <a href="/duplicate_plan/{{ plan.id }}" class="btn btn-outline-primary">üìÑ Duplicar Plan</a>
                    <a href="/delete_plan/{{ plan.id }}" class="btn btn-outline-danger" onclick="return confirm('¬øBorrar plan?')">üóëÔ∏è Eliminar</a>
                    {% endif %}
                </div>
            </div>

            <div class="col-lg-8">
                <h5 class="fw-bold mb-3">Estructura del Entrenamiento</h5>
                
                {% for item in plan.items|sort(attribute='order') %}
                <div class="card mb-3 shadow-sm border-0 position-relative">
                    <div class="card-body d-flex align-items-center p-3">
                        <div class="me-3 text-center" style="min-width: 50px;">
                            <h3 class="fw-bold text-primary mb-0">{{ item.duration }}'</h3>
                            <small class="text-muted" style="font-size: 0.7rem;">MIN</small>
                        </div>
                        <div class="flex-grow-1 cursor-pointer" style="cursor: pointer;" 
                             data-bs-toggle="modal" data-bs-target="#drillModal" data-bs-url="/drill/{{ item.drill.id }}">
                            <span class="badge bg-secondary mb-1">{{ item.block_name }}</span>
                            <h5 class="fw-bold mb-0 text-truncate">{{ item.drill.title }}</h5>
                        </div>
                    </div>
                </div>
                {% endfor %}

                {% if plan.user_id == current_user.id %}
                <div class="text-center mt-4 p-4 border border-dashed rounded bg-white">
                    <p class="text-muted">Para a√±adir o quitar ejercicios, usa el bot√≥n de "Editar Plan".</p>
                    <a href="/edit_plan/{{ plan.id }}" class="btn btn-primary btn-sm">Ir a Editar</a>
                </div>
                {% endif %}
            </div>
        </div>

    </div>

    <div class="modal fade" id="drillModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"></div></div></div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const drillModal = document.getElementById('drillModal')
        drillModal.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget
            const url = button.getAttribute('data-bs-url')
            const modalContent = drillModal.querySelector('.modal-content')
            modalContent.innerHTML = '<div class="p-5 text-center"><div class="spinner-border text-primary"></div></div>'
            fetch(url).then(r => r.text()).then(html => { modalContent.innerHTML = html })
        })
    </script>
</body>
</html>