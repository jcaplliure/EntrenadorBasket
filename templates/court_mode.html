<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Modo Pista - {{ plan.name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #121212; color: #ffffff; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        .drill-container { flex-grow: 1; display: none; flex-direction: column; padding: 20px; overflow-y: auto; text-align: center; }
        .drill-container.active { display: flex; }
        
        /* Cronómetro */
        .timer-display { font-size: 4rem; font-weight: bold; font-family: monospace; color: #0d6efd; margin: 10px 0; }
        .timer-controls button { width: 60px; height: 60px; border-radius: 50%; font-size: 1.5rem; margin: 0 10px; }
        
        /* Imagen grande */
        .media-box { 
            width: 100%; height: 250px; background: #222; margin-bottom: 20px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
        }
        .media-box img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; }
        .play-overlay { position: absolute; font-size: 4rem; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        /* Botones navegación */
        .nav-bar { background: #1e1e1e; padding: 15px; display: flex; justify-content: space-between; gap: 10px; border-top: 1px solid #333; }
        .nav-btn { flex-grow: 1; height: 50px; font-weight: bold; font-size: 1.1rem; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="d-flex justify-content-between align-items-center p-3 border-bottom border-secondary bg-dark">
        <h5 class="mb-0 text-truncate" style="max-width: 80%;">{{ plan.name }}</h5>
        <a href="/plan/{{ plan.id }}" class="btn btn-outline-light btn-sm"><i class="bi bi-x-lg"></i></a>
    </div>

    {% for item in plan.items %}
    <div class="drill-container {% if loop.first %}active{% endif %}" id="drill-{{ loop.index0 }}" data-duration="{{ item.duration }}">
        
        <div class="text-secondary small text-uppercase fw-bold mb-2">
            BLOQUE: {{ item.block_name }} • Ejercicio {{ loop.index }} de {{ plan.items|length }}
        </div>
        
        <h2 class="fw-bold mb-3">{{ item.drill.title }}</h2>

        <div class="media-box" onclick="openMedia('{{ item.drill.media_type }}', '{{ item.drill.media_file }}', '{{ item.drill.external_link }}')">
            {% if item.drill.media_type == 'image' and item.drill.media_file %}
                <img src="{{ url_for('static', filename='uploads/' + item.drill.media_file) }}">
            {% elif item.drill.media_type == 'link' and 'youtu' in (item.drill.external_link or '') %}
                <img src="{{ item.drill.external_link|youtube_thumb }}">
                <i class="bi bi-play-circle-fill play-overlay"></i>
            {% elif item.drill.media_type == 'pdf' %}
                <div class="text-center"><i class="bi bi-file-pdf display-1 text-danger"></i><br>Ver PDF</div>
            {% else %}
                <div class="text-center"><i class="bi bi-image display-1 text-muted"></i></div>
            {% endif %}
        </div>

        <div class="timer-section">
            <div class="timer-display" id="timer-{{ loop.index0 }}">
                {{ "%02d" % item.duration }}:00
            </div>
            <div class="timer-controls">
                <button class="btn btn-success" onclick="startTimer({{ loop.index0 }})"><i class="bi bi-play-fill"></i></button>
                <button class="btn btn-warning" onclick="pauseTimer({{ loop.index0 }})"><i class="bi bi-pause-fill"></i></button>
                <button class="btn btn-danger" onclick="resetTimer({{ loop.index0 }}, {{ item.duration }})"><i class="bi bi-arrow-counterclockwise"></i></button>
            </div>
        </div>

        <p class="mt-4 text-start text-light opacity-75" style="white-space: pre-wrap;">{{ item.drill.description }}</p>
    </div>
    {% else %}
    <div class="d-flex align-items-center justify-content-center h-100 text-muted">
        <h3>Plan vacío</h3>
    </div>
    {% endfor %}

    <div class="nav-bar">
        <button class="btn btn-secondary nav-btn" onclick="prevDrill()"><i class="bi bi-chevron-left"></i> Anterior</button>
        <button class="btn btn-primary nav-btn" onclick="nextDrill()">Siguiente <i class="bi bi-chevron-right"></i></button>
    </div>

    <script>
        let currentIdx = 0;
        const totalDrills = {{ plan.items|length }};
        let timers = {}; // Guardar intervalos

        function showDrill(idx) {
            document.querySelectorAll('.drill-container').forEach(el => el.classList.remove('active'));
            document.getElementById('drill-' + idx).classList.add('active');
        }

        function nextDrill() {
            if (currentIdx < totalDrills - 1) {
                currentIdx++;
                showDrill(currentIdx);
            }
        }

        function prevDrill() {
            if (currentIdx > 0) {
                currentIdx--;
                showDrill(currentIdx);
            }
        }

        // Lógica del Cronómetro
        function startTimer(idx) {
            if (timers[idx]) return; // Ya corre
            
            const display = document.getElementById('timer-' + idx);
            let [mins, secs] = display.innerText.split(':').map(Number);
            let totalSeconds = mins * 60 + secs;

            timers[idx] = setInterval(() => {
                if (totalSeconds > 0) {
                    totalSeconds--;
                    const m = Math.floor(totalSeconds / 60);
                    const s = totalSeconds % 60;
                    display.innerText = `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
                } else {
                    clearInterval(timers[idx]);
                    timers[idx] = null;
                    // Alarma visual (rojo)
                    display.style.color = '#dc3545';
                }
            }, 1000);
        }

        function pauseTimer(idx) {
            clearInterval(timers[idx]);
            timers[idx] = null;
        }

        function resetTimer(idx, originalMins) {
            pauseTimer(idx);
            document.getElementById('timer-' + idx).innerText = `${originalMins.toString().padStart(2, '0')}:00`;
            document.getElementById('timer-' + idx).style.color = '#0d6efd';
        }

        function openMedia(type, file, link) {
            if (type === 'link') window.open(link, '_blank');
            else if (type === 'pdf' || type === 'image') window.open('/static/uploads/' + file, '_blank');
        }
    </script>
</body>
</html>