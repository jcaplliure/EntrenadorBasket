<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pizarra Entrenador</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .card-img-top { height: 180px; object-fit: cover; background: #eee; }
        .card-video-placeholder { height: 180px; background: #000; display: flex; align-items: center; justify-content: center; color: white; }
        .icon-action { cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .icon-action:hover { transform: scale(1.2); }
        .text-orange { color: #e65100; }
        .bg-orange { background-color: #e65100; color: white; }
        .badge-private { background: #333; color: white; position: absolute; top: 10px; right: 10px; opacity: 0.8; }
    </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-orange mb-4">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/"><i class="bi bi-basket"></i> Entrenador Basket</a>
        <div class="d-flex align-items-center">
            <span class="text-white me-3 d-none d-md-block">{{ current_user.name }}</span>
            <a href="/create" class="btn btn-light btn-sm fw-bold me-2">+ Nuevo</a>
            <a href="/logout" class="btn btn-outline-light btn-sm">Salir</a>
        </div>
    </div>
</nav>

<div class="container">
    <form action="/" method="get" class="bg-white p-3 rounded shadow-sm mb-4">
        <div class="row g-2 align-items-end">
            <div class="col-md-4">
                <label class="form-label small fw-bold">Buscar</label>
                <input type="text" name="q" class="form-control form-control-sm" placeholder="T칤tulo..." value="{{ request.args.get('q', '') }}">
            </div>
            
            <div class="col-md-3">
                <label class="form-label small fw-bold">Categor칤a</label>
                <select name="primary" class="form-select form-select-sm">
                    <option value="">Todas</option>
                    {% for tag in tags %}
                    <option value="{{ tag.id }}" {% if request.args.get('primary') == tag.id|string %}selected{% endif %}>{{ tag.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label class="form-label small fw-bold">Ordenar</label>
                <select name="sort_by" class="form-select form-select-sm">
                    <option value="date_desc">M치s recientes</option>
                    <option value="views_desc" {% if request.args.get('sort_by') == 'views_desc' %}selected{% endif %}>M치s Vistos</option>
                    <option value="favs_desc" {% if request.args.get('sort_by') == 'favs_desc' %}selected{% endif %}>M치s Populares (Favs)</option>
                </select>
            </div>

            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-dark btn-sm">Filtrar</button>
            </div>
        </div>

        <div class="mt-3 pt-2 border-top">
            <span class="small fw-bold me-2">Mostrar:</span>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="filter_type" value="my_private" id="f1" {% if 'my_private' in request.args.getlist('filter_type') %}checked{% endif %}>
                <label class="form-check-label small" for="f1">Mis Privados 游</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="filter_type" value="my_public" id="f2" {% if 'my_public' in request.args.getlist('filter_type') %}checked{% endif %}>
                <label class="form-check-label small" for="f2">Mis P칰blicos 游깴</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="filter_type" value="others" id="f3" {% if 'others' in request.args.getlist('filter_type') %}checked{% endif %}>
                <label class="form-check-label small" for="f3">Comunidad 游논</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="filter_type" value="favorites" id="f4" {% if 'favorites' in request.args.getlist('filter_type') %}checked{% endif %}>
                <label class="form-check-label small text-danger fw-bold" for="f4">Favoritos 仇벒잺</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="filter_type" value="next_practice" id="f5" {% if 'next_practice' in request.args.getlist('filter_type') %}checked{% endif %}>
                <label class="form-check-label small text-primary fw-bold" for="f5">Pr칩ximo Entrene 游늶</label>
            </div>
            {% if 'next_practice' in request.args.getlist('filter_type') %}
            <a href="/clear_practice" class="btn btn-outline-danger btn-sm py-0 ms-2" style="font-size: 0.7rem;">Limpiar Entrene</a>
            {% endif %}
        </div>
    </form>

    <div class="row row-cols-1 row-cols-md-3 g-4">
        {% for drill in drills %}
        <div class="col">
            <div class="card h-100 shadow-sm border-0">
                <div class="position-relative">
                    {% if not drill.is_public %}
                        <span class="badge badge-private"><i class="bi bi-lock-fill"></i> Privado</span>
                    {% endif %}
                    
                    {% if drill.media_file and not (drill.media_file|is_video) %}
                        <img src="{{ url_for('static', filename='uploads/' + drill.media_file) }}" class="card-img-top">
                    {% elif drill.external_link and (drill.external_link|youtube_thumb) %}
                        <img src="{{ drill.external_link|youtube_thumb }}" class="card-img-top">
                    {% elif drill.media_file and (drill.media_file|is_video) %}
                        <video class="card-img-top" style="background:#000;">
                            <source src="{{ url_for('static', filename='uploads/' + drill.media_file) }}#t=0.5" type="video/mp4">
                        </video>
                        <div class="position-absolute top-50 start-50 translate-middle text-white fs-1"><i class="bi bi-play-circle"></i></div>
                    {% else %}
                        <div class="card-img-top d-flex align-items-center justify-content-center bg-light text-muted fs-1">
                            <i class="bi bi-link-45deg"></i>
                        </div>
                    {% endif %}
                </div>

                <div class="card-body">
                    <h5 class="card-title fw-bold text-truncate">{{ drill.title }}</h5>
                    <div class="mb-2">
                        {% for tag in drill.primary_tags %}
                            <span class="badge bg-secondary">{{ tag.name }}</span>
                        {% endfor %}
                    </div>
                    <p class="card-text small text-muted text-truncate">{{ drill.description or 'Sin descripci칩n' }}</p>
                </div>
                
                <div class="card-footer bg-white border-top-0 d-flex justify-content-between align-items-center">
                    <div class="small text-muted">
                        <i class="bi bi-eye"></i> {{ drill.views }}
                    </div>
                    <div>
                        <a href="/toggle_practice/{{ drill.id }}" class="text-decoration-none me-3 icon-action" title="A침adir a pr칩ximo entrene">
                            {% if drill in current_user.mochila %}
                                <i class="bi bi-clipboard-check-fill text-primary"></i>
                            {% else %}
                                <i class="bi bi-clipboard text-muted"></i>
                            {% endif %}
                        </a>
                        
                        <a href="/toggle_fav/{{ drill.id }}" class="text-decoration-none me-3 icon-action" title="Favorito">
                            {% if drill in current_user.favoritos %}
                                <i class="bi bi-heart-fill text-danger"></i>
                            {% else %}
                                <i class="bi bi-heart text-muted"></i>
                            {% endif %}
                        </a>

                        {% if drill.user_id == current_user.id or current_user.is_admin %}
                        <a href="/delete/{{ drill.id }}" class="text-decoration-none icon-action" onclick="return confirm('쮹orrar?');">
                            <i class="bi bi-trash text-muted"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
</body>
</html>